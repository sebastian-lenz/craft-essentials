<?php

namespace lenz\craft\essentials\services\malwareScanner;

use craft\elements\Asset;
use craft\events\AssetEvent;
use craft\helpers\App;
use lenz\craft\essentials\Plugin;
use lenz\craft\essentials\services\eventBus\On;

/**
 * Class MalwareScanner
 */
class MalwareScanner
{
  /**
   * @param AssetEvent $event
   * @return void
   */
  #[On(Asset::class, Asset::EVENT_BEFORE_HANDLE_FILE, [self::class, 'requiresHandler'])]
  static public function onBeforeHandleFile(AssetEvent $event): void {
    $filePath = $event->asset->tempFilePath;
    $command = App::parseEnv(Plugin::getInstance()->getSettings()->malwareCommand);

    if (!is_null($filePath) && !empty($command)) {
      $command = str_replace('{file}', escapeshellarg($filePath), $command);
      $result = shell_exec($command);

      if (!empty($result)) {
        throw new \Exception('Malware detected!');
      }
    }
  }

  /**
   * @return bool
   */
  static public function requiresHandler(): bool {
    $settings = Plugin::getInstance()->getSettings();
    return !empty($settings->malwareCommand);
  }
}
