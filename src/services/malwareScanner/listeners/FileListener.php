<?php

namespace lenz\craft\essentials\services\malwareScanner\listeners;

use craft\events\AssetEvent;
use craft\helpers\App;
use lenz\craft\essentials\Plugin;

/**
 * Class FileListener
 */
class FileListener
{
  /**
   * @param AssetEvent $event
   * @return void
   */
  static public function onBeforeHandleFile(AssetEvent $event): void {
    $filePath = $event->asset->tempFilePath;
    $command = App::parseEnv(Plugin::getInstance()->getSettings()->malwareCommand);

    if (!is_null($filePath) && !empty($command)) {
      $command = str_replace('{file}', escapeshellarg($filePath), $command);
      $result = shell_exec($command);

      if (!empty($result)) {
        throw new \Exception('Malware detected!');
      }
    }
  }
}
